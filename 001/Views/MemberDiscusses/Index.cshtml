@{
    ViewBag.Title = "Index";

    Layout = "~/Views/Shared/_Layout_Member.cshtml";



}


<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<link href="~/Content/MemberDiscussesStyle.css" rel="stylesheet" />



<div class="container">
    
    <div class="container001 ">
        <div>
            <h4 >會員聊天討論</h4>
        </div>
        <div class="container002 d-flex  ">
            <div class="container003  ">
                <!--對話紀錄存放區域↓-->
                <ul id="discussion"></ul>
            </div>

            <div class="r001">


                <div class="badge badge-pill badge-dark ">目前使用帳號： </div>
                <div class="input-group mb-5">
                    <div class="input-group-prepend">
                        <input class="form-control bg-dark text-center text-white " type="text" id="displayname" value="@Session["memberuser"]" readonly />
                    </div>
                </div>
                <div class="session" style="display:none" id="session" >@Session["memberuser"]</div>
            </div>
        </div>


        @*<div class="container">
            <input type="text" id="message" />
            <input type="button" id="sendmessage" value="發言" />
        </div>*@
        <div class="r001">
            <textarea id="message" placeholder="隨便說~!!!!" class="w-100"></textarea>
            <input type="button" id="sendmessage" value="發言" class="btn btn-outline-dark r001 w-100">
        </div>

    </div>

  


</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->

    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // 建立SignalR的變數連結
            var chat = $.connection.signalRHub;

            // 註冊該方法 將會由Server傳遞過來
            chat.client.addNewMessageToPage = function (name, message, time) {
                // Add the message to the page. 當有資料推播過來時將其寫進discussion 中



                @*var  memberuser = @ViewBag.useraccount;*@
                console.log($('#session').text());
                var memberuser = $('#session').text();

                if (name == memberuser) {
                    $('#discussion').append('<li class="text-right text-info"><strong>' + htmlEncode(name) + '<strong> >>' + htmlEncode(time)
                        + '</strong></br> ' + htmlEncode(message) + '</li>');

                } else {
                    $('#discussion').append('<li><strong>' + htmlEncode(name) + '<strong>' + htmlEncode(time)
                        + '</strong></br> ' + htmlEncode(message) + '</li>');
                }
                //$('#discussion').append('<li class="text-right text-info"><strong>' + htmlEncode(name) + '<strong> >>' + htmlEncode(time)
                //    + '</strong></br> ' + htmlEncode(message) + '</li>');

            };



            // 登入時讓使用者輸入自己的名字
            $('#displayname').val();
            //提示窗
            $().val(alert('提醒您 ! 目前登入聊天室的帳號 >> @Session["memberuser"]'));
            // 讓焦點放在該訊息框框上
            $('#message').focus();
            // 啟動SignalR 連結
            $.connection.hub.start().done(function () {
                //當連結建立完成後 有使用者對sendmessage Button Click時
                $('#sendmessage').click(function () {
                    // 傳遞資料給Server Send事件 將 (名字 , 訊息) 傳遞
                    chat.server.send($('#displayname').val(), $('#message').val());
                    // 清除輸入視窗的資料，並將焦點放在該位置上
                    $('#message').val('').focus();
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}

